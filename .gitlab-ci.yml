stages:
  - build_back
  - build_front
  - test_back
  - test_front
  - run

variables:
  CI: "false"
  MYSQL_ROOT_PASSWORD: comsc
  MYSQL_DATABASE: bt_router_db
  DB_HOST: mysql

services:
  - name: mysql:latest
    alias: mysql

before_script:
  - apt-get update -y && apt-get install -y curl unzip
  - apt-get install -y -qq --no-install-recommends default-mysql-client

build_back:
  stage: build_back
  image: maven:3.9.0-eclipse-temurin-17
  script:
    - cd backend
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - backend/target/*.jar

# ðŸŽ¨ **Step 2: Build Frontend**
build_front:
  stage: build_front
  image: node:20
  script:
    - cd frontend
    - npm install
    - npm run build
  artifacts:
    paths:
      - frontend/build

test_back:
  stage: test_back
  image: maven:3.9.0-eclipse-temurin-17
  services:
    - name: mysql:latest
      alias: mysql
  script:
    - mysql --user=root --password=$MYSQL_ROOT_PASSWORD $MYSQL_DATABASE < backend/src/main/resources/schema.sql
    - mysql --user=root --password=$MYSQL_ROOT_PASSWORD $MYSQL_DATABASE < backend/src/main/resources/data.sql
    - cd backend
    - mvn test

# ðŸ§ª **Step 4: Test Frontend**
test_front:
  stage: test_front
  image: node:20
  script:
    - cd frontend
    - npm install
    - npm test -- --watchAll=false

run:
  stage: run
  image: maven:3.9.0-eclipse-temurin-17
  services:
    - name: mysql:latest
      alias: mysql
  script:
    - echo "Waiting for MySQL to be ready..."
    - until mysql --host=$DB_HOST --user=$MYSQL_USER --password=$MYSQL_PASSWORD -e "SELECT 1" &>/dev/null; do
        echo "Waiting for database...";
        sleep 5;
      done
    - echo "MySQL is ready!"
    - mysql --host=$DB_HOST --user=$MYSQL_USER --password=$MYSQL_PASSWORD $MYSQL_DATABASE < backend/src/main/resources/schema.sql
    - mysql --host=$DB_HOST --user=$MYSQL_USER --password=$MYSQL_PASSWORD $MYSQL_DATABASE < backend/src/main/resources/data.sql
    - java -jar backend/target/*.jar &
    - sleep 10
    - curl --fail http://localhost:8080/api/health || exit 1
  only:
    - main
