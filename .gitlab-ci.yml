stages:
  - build_back
  - build_front
  - test_back
  - test_front
  - run

variables:
  CI: "false"
  MYSQL_ROOT_PASSWORD: comsc
  MYSQL_DATABASE: bt_router_db
  DB_HOST: mariadb

services:
  - name: mariadb:latest  
    alias: mariadb
    command:
      - --default-authentication-plugin=mysql_native_password

before_script:
  - apt-get update -y && apt-get install -y curl unzip mariadb-client

build_back:
  stage: build_back
  image: maven:3.9.0-eclipse-temurin-17
  script:
    - cd backend
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - backend/target/*.jar

build_front:
  stage: build_front
  image: node:20
  script:
    - cd frontend
    - npm install
    - npm run build
  artifacts:
    paths:
      - frontend/build

test_back:
  stage: test_back
  image: maven:3.9.0-eclipse-temurin-17
  services:
    - name: mariadb:latest
      alias: mariadb
  script:
    - echo "Waiting for MariaDB to be ready..."
    - sleep 15  # âœ… Ensures MariaDB is fully ready before running scripts
    - mysql --host=$DB_HOST --user=root --password=$MYSQL_ROOT_PASSWORD -e "SHOW DATABASES;"
    - mysql --host=$DB_HOST --user=root --password=$MYSQL_ROOT_PASSWORD $MYSQL_DATABASE < backend/src/main/resources/schema.sql
    - mysql --host=$DB_HOST --user=root --password=$MYSQL_ROOT_PASSWORD $MYSQL_DATABASE < backend/src/main/resources/data.sql
    - cd backend
    - mvn test

# ðŸ§ª **Step 4: Test Frontend**
test_front:
  stage: test_front
  image: node:20
  script:
    - cd frontend
    - npm install
    - npm test -- --watchAll=false

run:
  stage: run
  image: maven:3.9.0-eclipse-temurin-17
  services:
    - name: mariadb:latest
      alias: mariadb
  script:
    - echo "Waiting for MariaDB to be ready..."
    - sleep 15  # âœ… Ensures MariaDB is fully ready before running scripts
    - mysql --host=$DB_HOST --user=root --password=$MYSQL_ROOT_PASSWORD -e "SHOW DATABASES;"
    - mysql --host=$DB_HOST --user=root --password=$MYSQL_ROOT_PASSWORD $MYSQL_DATABASE < backend/src/main/resources/schema.sql
    - mysql --host=$DB_HOST --user=root --password=$MYSQL_ROOT_PASSWORD $MYSQL_DATABASE < backend/src/main/resources/data.sql
    - java -jar backend/target/*.jar &
    - sleep 10
    - curl --fail http://localhost:8080/api/health || exit 1
  only:
    - main

